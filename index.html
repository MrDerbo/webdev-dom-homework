<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="listAdd">
        <!-- Все рендерится из JS -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="nameInput"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="textTextarea"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="buttonAddForm">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
const forButtonAddForm = document.getElementById('buttonAddForm');
const forNameInput = document.getElementById('nameInput');
const forTextArea = document.getElementById('textTextarea');
const listAdd = document.getElementById('listAdd');

// Массив со значениями для комментариев:
const commentators = [
  {
    name: 'Глеб Фокин',
    date: '12.02.22 12:18',
    comment: 'Это будет первый комментарий на этой странице',
    likes: '3',
    isLiked: false
  },

  {
    name: 'Варвара Н.',
    date: '13.02.22 19:22',
    comment: 'Мне нравится как оформлена эта страница! ❤',
    likes: '75',
    isLiked: false
  }
];

// Рендеринг комментариев:
const renderCommentators = () => {
  const commentatorsHTML = commentators.map((commentator, index) => {
    return `<li class="comment" id="backgroundID">
      <div class="comment-header">
        <div>${commentator.name}</div>
        <div>${commentator.date}</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          ${commentator.comment}
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${commentator.likes}</span>
          <button class="like-button" data-index='${index}' ${commentator.isLiked ? '-active-like' : ''}></button>
        </div>
      </div>
    </li>`;
  }).join('')

  listAdd.innerHTML = commentatorsHTML;
};

// Функции для работы лайка (смотреть всё до функции с Датой):
const saveLikesState = () => {
  commentators.forEach((commentator, index) => {
    const likeButton = document.querySelector(`.like-button[data-index='${index}']`);
    if (likeButton) {
      commentator.isLiked = likeButton.classList.contains('-active-like');
    }
  });
};

const restoreLikesState = () => {
  commentators.forEach((commentator, index) => {
    const likeButton = document.querySelector(`.like-button[data-index='${index}']`);
    if (likeButton && commentator.isLiked) {
      likeButton.classList.add('-active-like');
    }
  });
};

const handleLikeClick = function() {
  const index = this.getAttribute('data-index');
  const commentator = commentators[index];
  const likesCounter = this.parentElement.querySelector('.likes-counter');
  
  if (commentator.isLiked) {
    commentator.likes = (parseInt(commentator.likes) - 1).toString();
    commentator.isLiked = false;
    this.classList.remove('-active-like');
  } else {
    commentator.likes = (parseInt(commentator.likes) + 1).toString();
    commentator.isLiked = true;
    this.classList.add('-active-like');
  }
  
  likesCounter.textContent = commentator.likes;
};

const initEventListeners = () => {
  const likeButtons = document.querySelectorAll('.like-button');
  likeButtons.forEach(button => {
    button.addEventListener('click', handleLikeClick);
  });
};

renderCommentators();
initEventListeners();

// Функция для нахождения даты:
function getFullDateForComment() {
  const now = new Date();
  
  const yearValue = now.getFullYear().toString().slice(-2); // Год в формате YY
  const monthValue = String(now.getMonth() + 1).padStart(2, '0'); // Месяц с ведущим нулём
  const dayValue = String(now.getDate()).padStart(2, '0'); // День с ведущим нулём
  const hoursValue = String(now.getHours()).padStart(2, '0'); // Часы с ведущим нулём
  const minutesValue = String(now.getMinutes()).padStart(2, '0'); // Минуты с ведущим нулём

  return `${dayValue}.${monthValue}.${yearValue} ${hoursValue}:${minutesValue}`;
}

// Функция ответа на комментарий после нажатия на текст комментария:
const answerToCommentByClick = () => {
  const clickedComments = document.querySelectorAll('.comment-text');

  for (const clickedComment of clickedComments) {
    clickedComment.addEventListener('click', () => {
      // Находим родительский элемент комментария (li)
      const commentElement = clickedComment.closest('.comment');
      
      // Получаем имя автора и текст комментария
      const authorName = commentElement.querySelector('.comment-header div').textContent;
      const commentText = clickedComment.textContent;

      return forTextArea.value =`> ${commentText}\n${authorName}, `;
    });
  }
};

answerToCommentByClick();

// Функция для добавления комментария на страницу, по нажатию на кнопку "Добавить":
forButtonAddForm.addEventListener('click', () => {
  const nameValue = forNameInput.value;
  const textareaValue = forTextArea.value;

  forNameInput.classList.remove('error');
  forTextArea.classList.remove('error');

  if (nameValue === '') {
    forNameInput.classList.add('error');
    return;
  }

  if (textareaValue === '') {
    forTextArea.classList.add('error');
    return;
  }

  // Перед тем, как запушить, делаем проверку и сохраняем значение лайка
  saveLikesState();

  // Пушим в массив комментариев новые значения комментария:
  commentators.push({
    name: nameValue,
    date: getFullDateForComment(),
    comment: textareaValue.replaceAll('<', '&lt;').replaceAll('>', '&gt;'),
    likes: '0',
    isLiked: false
  });

  renderCommentators(); // Рендерим комменты
  restoreLikesState(); // Восстанавливаем состояние лайков
  initEventListeners(); // Инициализируем обработчики событий для новых кнопок лайков
  answerToCommentByClick();
});
  </script>
</html>
